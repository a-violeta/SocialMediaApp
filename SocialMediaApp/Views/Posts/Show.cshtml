@model SocialMediaApp.Models.Post
@using System.Security.Claims

@{
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    bool isAdmin = User.IsInRole("Admin");
}

@* Afisarea unei postari*@

<!--verific daca am vreun mesaj de afisat pt utilizator-->
@if (TempData["message"] != null)
{
    var messageType = TempData["messageType"]?.ToString() ?? "info";
    <div class="alert alert-@messageType alert-dismissible fade show" role="alert">
        @TempData["message"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@* afisez validation summary daca exista erori *@
@if (!ViewData.ModelState.IsValid && ViewData.ModelState.Values.SelectMany(v => v.Errors).Any())
{
    <div asp-validation-summary="All" class="alert alert-danger"></div>
}

<br />

<div class="w-700px-responsive profile-post position-relative d-flex flex-row mt-3 mb-5 cursor-default me-auto ms-auto">
    <div class="post-pfp-container">
        <img src="~/images/Profiles/@Model.User.ProfilePicture" />
    </div>
    <div class="profile-post-info d-flex flex-column text-wrap text-break position-relative">
        <div class="profile-post-username">
            <b>@Model.User.FirstName @Model.User.LastName</b>

            @if (currentUserId == Model.UserId)
            {
                <a asp-action="Edit"
                   asp-controller="Posts"
                   asp-route-id="@Model.Id"
                   class="btn btn-sm btn-outline-primary">
                    Edit
                </a>
            }

            @if (currentUserId == Model.UserId || isAdmin)
            {
                <form asp-action="Delete" asp-controller="Posts" method="post"
                      onsubmit="return confirm('Are you sure you want to delete this post?');"
                      class="d-inline ms-2">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
            }

        </div>
        <div class="profile-post-content d-flex flex-column">@Model.TextContent</div>
        @if (Model.Images.Any() || Model.Videos.Any())
        {
            <div class="post-media d-flex w-100 position-relative">
                <div class="arrow-left w-25 d-flex justify-content-center align-items-center">
                    <div class="arrow-left-button d-flex cursor-pointer">
                        &lt;
                    </div>
                </div>

                <div id="mediaContainer" class="media-container d-flex justify-content-center align-items-center" data-post-id="@Model.Id">
                    
                </div>

                <div class="arrow-right w-25 d-flex justify-content-center align-items-center">
                    <div class="arrow-right-button d-flex cursor-pointer">
                        &gt;
                    </div>
                </div>
            </div>
        }
        <div class="post-data d-flex flex-wrap mt-3">
            <div class="post-options d-flex">
                <div class="profile-post-likes d-flex justify-content-between me-3 cursor-pointer"
                     data-post-id="@Model.Id"
                     onclick="toggleLike(this)">
                     <!--stupizenia asta tot nu se coloreaza cand dau like, dar asta e-->
                    <i class="bi @(ViewBag.HasLiked ? "bi-heart-fill text-danger" : "bi-heart")"></i>
                     <span class="likes-count">@Model.WhoLiked.Count()</span>
                </div>
                <div class="profile-post-comments d-flex justify-content-between">
                    <a><i class="bi bi-chat-dots"></i> @Model.Comments.Count()</a>
                </div>
            </div>
            <div class="post-date d-flex">
                @Model.Date
            </div>
        </div>
    </div>
</div>


@* Afisarea formularului in care se poate adauga un comentariu *@

<div class="d-flex flex-column align-items-center">

    <div class="w-700px-responsive">

        <form method="post" asp-controller="Posts" asp-action="Show">

            <div class="d-flex flex-column">

                <input type="hidden" name="PostId" value="@Model.Id" />

                <label class="text-muted mb-1">Add a comment</label>

                <textarea class="form-control mb-3" name="Content"></textarea>

                <button class="btn btn-primary ms-auto" type="submit">Comment</button>

            </div>

        </form>

    </div>

</div>

@* Afisare comentarii impreuna cu butoanele de editare si stergere *@

@foreach (var comm in Model.Comments)
{
    <div class="container">
        <div class="row">
            <div class="col-md-2"></div>

            <div class="col-md-8">

                <div>

                    <p>@comm.Content</p>

                    @if(comm.User != null)
                    {
                        <strong><i class="bi bi-person"> @comm.User.UserName</i></strong>
                    }

                </div>
                <br>
                <!--doar userul care a scris poate sa editeze sau sa stearga comentariul-->

                @if (comm.UserId == ViewBag.UserCurent)
                {
                    <div class="d-flex">
                        <div>
                            <a class="btn btn-outline-primary" asp-controller="Comments" asp-action="Edit" asp-route-id="@comm.Id">
                                <i class="bi bi-pencil-square"></i> Editeaza
                            </a>

                        </div>
                        <div>
                            <form method="post" asp-controller="Comments" asp-action="Delete" asp-route-id="@comm.Id">

                                <button class="btn btn-outline-danger" type="submit"><i class="bi bi-trash"></i>Sterge</button>

                            </form>
                        </div>
                    </div>
                }

                <!--admin poate sa stearga orice comentariu-->
                @if (ViewBag.EsteAdmin == true)
                {
                    <div class="d-flex">
                        <div>
                            <form method="post" asp-controller="Comments" asp-action="Delete" asp-route-id="@comm.Id">

                                <button class="btn btn-outline-danger" type="submit"><i class="bi bi-trash"></i>Sterge</button>

                            </form>
                        </div>
                    </div>
                }

                <br />

            </div>

            <div class="col-md-2"></div>

        </div>

    </div>
}
