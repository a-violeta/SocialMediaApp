@model SocialMediaApp.Models.Post
@using System.Security.Claims

@{
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    bool isAdmin = User.IsInRole("Admin");
}

@* Afisarea unei postari*@

<!--verific daca am vreun mesaj de afisat pt utilizator-->
@if (TempData["message"] != null)
{
    var messageType = TempData["messageType"]?.ToString() ?? "info";
    <div class="alert alert-@messageType alert-dismissible fade show" role="alert">
        @TempData["message"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@* afisez validation summary daca exista erori *@
@if (!ViewData.ModelState.IsValid && ViewData.ModelState.Values.SelectMany(v => v.Errors).Any())
{
    <div asp-validation-summary="All" class="alert alert-danger"></div>
}

<br />

<div class="w-700px-responsive profile-post position-relative d-flex flex-row mt-3 mb-5 cursor-default me-auto ms-auto">
    <div class="post-pfp-container">
        @if (Model.User != null)
        {
            <a asp-action = "Show"
                asp-controller = "Users"
                asp-route-id="@Model.UserId">
            <img src="~/images/Profiles/@Model.User.ProfilePicture" />
            </a>
        }
        else
        {
            <img src="~/images/Profiles/default-pfp.jpg" />
        }
    </div>
    <div class="profile-post-info d-flex flex-column text-wrap text-break position-relative">
        <div class="profile-post-username d-flex w-100">
            @if (Model.User != null) 
            {
                <a class="me-auto text-decoration-none text-dark"
                    asp-action = "Show"
                    asp-controller = "Users"
                    asp-route-id="@Model.UserId">
                    <b >@Model.User.FirstName @Model.User.LastName</b>
                </a>
            }
            else
            {
                <b class="me-auto">Deleted user</b>
            }
            @if (Model.User != null)
            {
                @if (currentUserId == Model.UserId)
                {
                    <a asp-action="Edit"
                    asp-controller="Posts"
                    asp-route-id="@Model.Id"
                    class="btn btn-sm btn-outline-primary">
                        Edit
                    </a>
                }

                @if (currentUserId == Model.UserId || isAdmin)
                {
                    <form asp-action="Delete" asp-controller="Posts" method="post"
                    onsubmit="return confirm('Are you sure you want to delete this post?');"
                    class="d-inline ms-2">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                }
            }

        </div>
        <div class="profile-post-content d-flex flex-column mb-3">@Model.TextContent</div>
        @if (Model.Images.Any() || Model.Videos.Any())
        {
            <div class="post-media d-flex w-100 position-relative">
                @if (Model.Images.Count() + Model.Videos.Count() > 1) 
                {
                    <div class="arrow-left w-25 d-flex justify-content-center align-items-center">
                        <div class="arrow-left-button d-flex cursor-pointer">
                            &lt;
                        </div>
                    </div>
                }

                <div id="mediaContainer" class="media-container d-flex justify-content-center align-items-center" data-post-id="@Model.Id">
                    
                </div>
                @if (Model.Images.Count() + Model.Videos.Count() > 1)
                {
                    <div class="arrow-right w-25 d-flex justify-content-center align-items-center">
                        <div class="arrow-right-button d-flex cursor-pointer">
                            &gt;
                        </div>
                    </div>
                }
            </div>
        }
        <div class="post-data d-flex flex-wrap mt-3">
            <div class="post-options d-flex">
                <div class="profile-post-likes d-flex justify-content-between me-3 cursor-pointer"
                     data-post-id="@Model.Id"
                     onclick="toggleLike(this)">
                     
                    <i class="heart-button bi @(ViewBag.HasLiked ? "bi-heart-fill text-danger" : "bi-heart")"></i>
                     <span class="likes-count">@Model.WhoLiked.Count()</span>
                </div>
                <div class="profile-post-comments d-flex justify-content-between">
                    <a><i class="bi bi-chat-dots"></i> @Model.Comments.Count()</a>
                </div>
            </div>
            <div class="post-date d-flex">
                @Model.Date
            </div>
        </div>
    </div>
</div>


@* Afisarea formularului in care se poate adauga un comentariu *@

<div class="d-flex flex-column align-items-center">

    <div class="w-700px-responsive">

        <form method="post" asp-controller="Comments" asp-action="New">

            <div class="d-flex flex-column">

                <input type="hidden" name="PostId" value="@Model.Id" />

                <label class="text-muted mb-1">Add a comment</label>

                <textarea class="form-control mb-3" name="Content"></textarea>

                <button class="btn btn-primary ms-auto" type="submit">Comment</button>

            </div>

        </form>

    </div>

</div>

@* Afisare comentarii impreuna cu butoanele de editare si stergere *@

@foreach (var comm in Model.Comments)
{
    <div class="container">
        <div class="row">
            <div class="col-md-2"></div>

            <div class="col-md-8">

                <div>
                    <p>@comm.Content</p>

                    @if (comm.User != null)
                    {   
                        <a asp-controller = "Users"
                            asp-action = "Show"
                            asp-route-id = "@comm.UserId"
                            class="text-decoration-none text-dark">
                            <i class="bi bi-person"> @comm.User.FirstName @comm.User.LastName</i>
                        </a>
                    }
                    else
                    {
                        <i class="bi bi-person text-muted"> Deleted user </i>
                    }
                </div>
                <br>

                @* butoane edit/delete *@
                @if ((comm.UserId != null && comm.UserId == currentUserId) || isAdmin)
                {
                    <div class="d-flex gap-2">

                        @* doar autorul poate edita *@
                        @if (comm.UserId != null && comm.UserId == currentUserId)
                        {
                            <a class="btn btn-outline-primary btn-sm" asp-controller="Comments" asp-action="Edit" asp-route-id="@comm.Id">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                        }

                        @* autorul si admin pot sterge *@
                        <form method="post" asp-controller="Comments" asp-action="Delete" asp-route-id="@comm.Id">
                            <button class="btn btn-outline-danger btn-sm" type="submit">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </form>

                    </div>
                }

                <br />

            </div>
            <div class="col-md-2"></div>
        </div>
    </div>
}
