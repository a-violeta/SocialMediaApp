@using System.Security.Claims
@model Group

<h3>Messages – @Model.Name</h3>

<a asp-action="Show"
   asp-controller="Groups"
   asp-route-id="@Model.Id"
   class="btn btn-sm btn-outline-secondary mb-3">
    ← Back to group main page
</a>

@if (TempData["MessageError"] != null)
{
    <div class="alert alert-danger">
        @TempData["MessageError"]
    </div>
}

@{
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    bool isModerator = ViewBag.IsModerator == true;
    DateTime? lastDate = null;
    var today = DateTime.Today;
    var yesterday = today.AddDays(-1);
}


<div class="border rounded p-3 mb-3"
     style="max-height: 350px; overflow-y: auto;">

    @if (!Model.Messages.Any())
    {
        <p class="text-muted">There are no messages.</p>
    }
    else
    {
        @foreach (var msg in Model.Messages.OrderBy(m => m.CreatedAt))
        {
            //afisam data calendaristica doar cand se schimba ziua
            if (lastDate == null || msg.CreatedAt.Date != lastDate.Value.Date)
            {
                <div class="text-center text-muted small my-3">
                    @{
                        if (msg.CreatedAt.Date == today)
                        {
                            <span>Today</span>
                        }
                        else if (msg.CreatedAt.Date == yesterday)
                        {
                            <span>Yesterday</span>
                        }
                        else
                        {
                            <span>
                                <!--asta cred ca afiseaza data in romana direct-->
                                @msg.CreatedAt.ToString("dd MMM yyyy")
                            </span>
                        }
                    }
                </div>

                lastDate = msg.CreatedAt.Date;
            }

            bool isOwnMessage = msg.UserId == currentUserId;

            <div class="d-flex mb-2 @(isOwnMessage ? "justify-content-end" : "justify-content-start")">
                <div class="d-flex @(isOwnMessage ? "flex-row-reverse" : "")" style="max-width:75%;">

                    <!-- poza profil -->
                    <img src="~/images/Profiles/@(msg.User?.ProfilePicture ?? "default.png")"
                         class="rounded-circle me-2 ms-2"
                         style="width:40px;height:40px;object-fit:cover;" />


                    <div class="p-2 rounded @(isOwnMessage ? "bg-primary text-white" : "bg-light")">

                        <small class="fw-bold d-block">
                            @msg.User?.FirstName
                        </small>

                        <div>@msg.TextContent</div>

                        <small class="text-muted d-block text-end">
                            @msg.CreatedAt.ToString("HH:mm")
                        </small>

                        @* butoane edit / delete *@
                        @if (isOwnMessage || isModerator)
                        {
                            <div class="text-end mt-1">

                                @if (isOwnMessage)
                                {
                                    <button class="btn btn-sm btn-outline-light me-1"
                                            onclick="toggleEdit(@msg.Id)">
                                        Edit
                                    </button>
                                }

                                <form asp-action="DeleteMessage"
                                      asp-controller="Groups"
                                      method="post"
                                      class="d-inline"
                                      onsubmit="return confirm('Are you sure you want to delete the message?');">
                                    <input type="hidden" name="id" value="@msg.Id" />
                                    <button type="submit"
                                            class="btn btn-sm btn-outline-danger">
                                        Delete
                                    </button>
                                </form>
                          </div>
                        }
                    </div>
                </div>
            </div>

            @* Form edit inline *@
            @if (isOwnMessage)
            {
                <form id="edit-form-@msg.Id"
                      asp-action="EditMessage"
                      asp-controller="Groups"
                      method="post"
                      style="display:none;"
                      class="mb-3 text-end">

                    <input type="hidden" name="id" value="@msg.Id" />
                    <input type="hidden" name="groupId" value="@Model.Id" />

                    <textarea name="textContent"
                              class="form-control mb-1"
                              rows="2">
                        @msg.TextContent
                    </textarea>

                    <button type="submit"
                            class="btn btn-sm btn-primary">
                        Send
                    </button>

                    <button type="button"
                            class="btn btn-sm btn-secondary"
                            onclick="toggleEdit(@msg.Id)">
                        Cancel
                    </button>
                </form>
            }

        }

    }
</div>

<form asp-action="AddMessage"
      asp-controller="Groups"
      method="post">

    <input type="hidden" name="groupId" value="@Model.Id" />

    <textarea name="textContent"
              class="form-control mb-2"
              rows="3"
              placeholder="Write a message..."
              required></textarea>

    <button type="submit"
            class="btn btn-primary btn-sm">
        Send
    </button>
</form>

<!--edit mesaj inline-->

@section Scripts {
    <script>
        function toggleEdit(id) {
            const form = document.getElementById(`edit-form-${id}`);
            form.style.display = form.style.display === "none" ? "block" : "none";
        }
    </script>
}
